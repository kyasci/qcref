      module test_ci
        use basis
        use mtrx
        use uga
        use ci
        implicit none
        private
        public::test_main
        real(8),parameter::TOL_=1d-7

      contains

        subroutine run_(mes,ian,r,cm,nx,nfc,nac,mult,v0,vlg)
          implicit none
          character(*),intent(in)::mes
          integer,intent(in)::ian(:),nx,nfc,nac,mult
          real(8),intent(in)::r(:,:),cm(:,:),v0,vlg(:,:)
          logical::ok
          integer::nc,i,ne
          integer,allocatable::lc1(:,:),lc2(:,:)
          real(8)::en
          real(8),allocatable::
     &      hb(:),tb(:),hc(:),ea(:),ca(:,:),vc1(:),vc2(:),hm(:),tm(:)
          ! Prepare basis set.
          call basis_init()
          do i=1,SIZE(ian)
            call basis_set('STO3G',ian(i),i)
          end do
          ! Evalate AO integrals.
          call basis_enuc(r,ian,en)
          call basis_hij(r,ian,hb)
          call basis_ijkl(r,tb)
          ! Transform AO integrals into the MO basis.
          allocate(hm(SIZE(hb)),tm(SIZE(tb)))
          hm(:)=hb(:)
          tm(:)=tb(:)
          call mtrx_utau(cm,hm)
          call mtrx_utau2(cm,tm)
          ! Generate 1e and 2e coupling constants (UGA).
          ne=SUM(ian)
          call uga_init(ne,nfc,nac,mult,nx)
          call uga_cc1(lc1,vc1)
          call uga_cc2(lc2,vc2)
          ! Evaluate solve the CI matrix.
          call ci_hcsf(lc1,vc1,lc2,vc2,hm,tm,hc)
          call uga_dim(nc)
          allocate(ea(nc))
          allocate(ca(nc,nc))
          call mtrx_eigsp(hc,ea,ca)
          ea(:)=ea(:)+en
          ! Check the CI energy.
          ok=(ea(1)-v0)**2<TOL_
          ! Check the 1e reduced density matrix.
          call check_dm1_(lc1,vc1,ca,hm,ok)
          ! Check the 1e reduced density matrix.
          call check_dm2_(lc1,vc1,lc2,vc2,ca,tm,ok)
          ! Check the Lagrangian matrix.
          call check_lagran_(lc1,vc1,lc2,vc2,ca,hm,tm,vlg,ok)
          ! Check the results.
          call asserttrue_(mes,ok)
        end subroutine

        subroutine check_lagran_(lc1,vc1,lc2,vc2,ca,hm,tm,vlg,ok)
          ! Calculate 2e energy in different two ways for comparison.
          implicit none
          integer,intent(in)::lc1(:,:),lc2(:,:)
          real(8),intent(in)::vc1(:),vc2(:),ca(:,:),hm(:),tm(:),vlg(:,:)
          logical,intent(inout)::ok
          integer::nb,nb2,i,nfzc,nacc
          real(8),allocatable::dm1(:),dm2(:),e(:,:),ea(:,:)
          ! Calculate 2e energy by using the reduced 2e density matrix.
          nb2=SIZE(hm)
          call iup_(nb2,nb,i)
          nfzc=MINVAL(lc1(3,:))-1
          nacc=MAXVAL(lc1(3,:))-nfzc
          allocate(dm1(nb2),dm2(SIZE(tm)),e(nb,nb),ea(nacc,nacc))
          call ci_dm1(lc1,vc1,(/1d0,0d0/),ca,dm1)
          call ci_dm2(lc1,vc1,lc2,vc2,(/1d0,0d0/),ca,dm2)
          call ci_lgr(nfzc,nacc,dm1,dm2,hm,tm,e)
          ea(:nacc,:nacc)=e(nfzc+1:nfzc+nacc,nfzc+1:nfzc+nacc)
          ok=ok.and.SUM((vlg(:,:)-ea(:,:))**2)<TOL_
        end subroutine

        subroutine check_dm1_(lc1,vc1,ca,hm,ok)
          ! Calculate 1e energy in two different ways for comparison.
          implicit none
          integer,intent(in)::lc1(:,:)
          real(8),intent(in)::vc1(:),ca(:,:),hm(:)
          logical,intent(inout)::ok
          integer::nc,nc2,ic,jc,ijc
          real(8)::v0,v1
          real(8),allocatable::dm1(:),h1(:),pc(:)
          ! Calculate 1e energy by using the reduced 1e density matrix.
          allocate(dm1(SIZE(hm)))
          call ci_dm1(lc1,vc1,(/1d0,0d0/),ca,dm1)
          call mtrx_expv(dm1,hm,v0)
          ! Calculate 1e energy by using the CI density matrix.
          nc=SIZE(ca(:,1))
          nc2=ip_(nc,nc)
          allocate(h1(nc2),pc(nc2))
          call ci_int1(lc1,vc1,hm,h1)
          do ijc=1,nc2
            call iup_(ijc,ic,jc)
            pc(ijc)=ca(ic,1)*ca(jc,1)
          end do
          call mtrx_expv(pc,h1,v1)
          ! Compare the results.
          ok=ok.and.(v1-v0)**2<TOL_
        end subroutine

        subroutine check_dm2_(lc1,vc1,lc2,vc2,ca,tm,ok)
          ! Calculate 2e energy in different two ways for comparison.
          implicit none
          integer,intent(in)::lc1(:,:),lc2(:,:)
          real(8),intent(in)::vc1(:),vc2(:),ca(:,:),tm(:)
          logical,intent(inout)::ok
          integer::nc,nc2,ic,jc,ijc
          real(8)::v0,v1
          real(8),allocatable::dm2(:),h2(:),pc(:)
          ! Calculate 2e energy by using the reduced 2e density matrix.
          allocate(dm2(SIZE(tm)))
          call ci_dm2(lc1,vc1,lc2,vc2,(/1d0,0d0/),ca,dm2)
          call mtrx_expv2(dm2,tm,v0)
          ! Calculate 2e energy by using the CI density matrix.
          nc=SIZE(ca(:,1))
          nc2=ip_(nc,nc)
          allocate(h2(nc2),pc(nc2))
          call ci_int2(lc1,vc1,lc2,vc2,tm,h2)
          do ijc=1,nc2
            call iup_(ijc,ic,jc)
            pc(ijc)=ca(ic,1)*ca(jc,1)
          end do
          call mtrx_expv(pc,h2,v1)
          ! Compare the results.
          ok=ok.and.(v1-v0)**2<TOL_
        end subroutine

        subroutine test_ci_h2_()
!-----------------------------------------------------------------------
!      $CONTRL SCFTYP=NONE RUNTYP=ENERGY CITYP=GUGA $END
!      $SYSTEM MWORDS=1 $END
!      $BASIS GBASIS=STO NGAUSS=3 $END
!      $CIINP NRNFG(6)=1,1 NPFLG(7)=1 $END
!      $CIDRT NFZC=0 NDOC=1 NVAL=1 GROUP=C1 IEXCIT=2 $END
!      $GUESS GUESS=MOREAD NORB=2 $END
!      $DATA
!     TITLE
!     C1
!      H           1.0  -0.3561016195   0.0000000000   0.0000000000
!      H           1.0   0.3561016195   0.0000000000   0.0000000000
!      $END
!      $VEC
!      1  1 5.45855912E-01 5.45855912E-01
!      2  1 1.24627656E+00-1.24627656E+00
!      $END
!-----------------------------------------------------------------------
          implicit none
          integer,parameter::NA=2,NB=2,NX=2,NFC=0,NAC=2,MULT=1
          integer::ian(NA)
          real(8)::r(3,NA)=0d0,cm(NB,NB),vlg(NAC,NAC),v0
          v0=-1.13684671d0
          ian(:)=(/1,1/)
          r(1,1)=1.345869
          cm(:,:)=RESHAPE((/
     &      0.54585591d0,0.54585591d0,
     &     -1.24627656d0,1.24627656d0/),(/NB,NB/))
          vlg(:,:)=RESHAPE((/
     &      -1.2051752256d0,-0.0000000000d0,
     &      -0.0000000000d0,-0.0326025325d0/),(/NAC,NAC/))
          call run_('H2',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        subroutine test_ci_h3_()
!-----------------------------------------------------------------------
!      $CONTRL SCFTYP=NONE RUNTYP=ENERGY CITYP=GUGA MULT=2 $END
!      $SYSTEM MWORDS=1 $END
!      $BASIS GBASIS=STO NGAUSS=3 $END
!      $CIINP NRNFG(6)=1,1 NPFLG(7)=1 $END
!      $CIDRT NFZC=0 NDOC=1 NALP=1 NVAL=1 GROUP=C1 IEXCIT=2 $END
!      $GUESS GUESS=MOREAD NORB=3 $END
!      $DATA
!     TITLE
!     C1
!      H           1.0  -0.3561016195   0.0000000000   0.0000000000
!      H           1.0   0.3561016195   0.0000000000   0.0000000000
!      H           1.0   1.0000000000   0.0000000000   0.0000000000
!      $END
!      $VEC
!      1  1 2.71198818E-01 5.30918421E-01 3.49099115E-01
!      2  1 9.04998237E-01-1.90737652E-02-7.97055649E-01
!      3  1-1.10052716E+00 1.92059371E+00-1.27391079E+00
!      $END
!-----------------------------------------------------------------------
          implicit none
          integer,parameter::NA=3,NB=3,NX=2,NFC=0,NAC=3,MULT=2
          integer::ian(NA)
          real(8)::r(3,NA),cm(NB,NB),vlg(NAC,NAC),v0
          v0=-1.4800112009d0
          ian(:)=(/1,1,1/)
          r(:,:)=RESHAPE((/
     &      -0.6729344846d0, 0.0000000000d0, 0.0000000000d0,
     &       0.6729344846d0, 0.0000000000d0, 0.0000000000d0,
     &       1.8897259877d0, 0.0000000000d0, 0.0000000000d0/),(/3,NA/))
          cm(:,:)=RESHAPE((/
     &       0.27119905d0, 0.53091842d0, 0.34909891d0,
     &       0.90499799d0,-0.01907359d0,-0.79705595d0,
     &      -1.10052730d0, 1.92059372d0,-1.27391066d0
     &       /),(/3,NA/))
          vlg(:,:)=RESHAPE((/
     &      -1.5071229888d0,-0.0260905201d0, 0.0063305579d0,
     &      -0.0260905201d0,-0.3317729570d0,-0.0015003277d0,
     &       0.0063305579d0,-0.0015003277d0,-0.0168185680d0
     &       /),(/NAC,NAC/))
          call run_('H3',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        subroutine test_ci_lih_()
!-----------------------------------------------------------------------
!      $CONTRL SCFTYP=NONE RUNTYP=ENERGY CITYP=GUGA $END
!      $SYSTEM MWORDS=5 $END
!      $BASIS GBASIS=STO NGAUSS=3 $END
!      $CIINP NRNFG(6)=1,1 NPFLG(7)=1 $END
!      $CIDRT NFZC=1 NDOC=1 NVAL=4 GROUP=C1 IEXCIT=2 $END
!      $GUESS GUESS=MOREAD NORB=6 $END
!      $DATA
!      HCP
!     C1
!      LI          3.0   1.5107517  0.0000000   0.0000000
!      H           1.0   0.0000000  0.0000000   0.0000000
!      $END
!      $VEC
!      1  1 9.91132081E-01 3.20863877E-02 7.08202419E-03 0.00000000E+00 0.00000000E+00
!      1  2 6.68998117E-03
!      2  1-1.73608167E-01 4.47090490E-01-3.49152578E-01 0.00000000E+00 0.00000000E+00
!      2  2 5.44484182E-01
!      3  1-2.08821153E-01 8.01188504E-01 6.12779289E-01-0.00000000E+00-0.00000000E+00
!      3  2-1.34352956E-01
!      4  1 0.00000000E+00 0.00000000E+00 0.00000000E+00 9.97572312E-01-6.96382251E-02
!      4  2 0.00000000E+00
!      5  1 0.00000000E+00 0.00000000E+00 0.00000000E+00 6.96382251E-02 9.97572312E-01
!      5  2 0.00000000E+00
!      6  1 8.06049471E-02-7.39134765E-01 1.00702598E+00 0.00000000E+00 0.00000000E+00
!      6  2 1.23175156E+00
!      $END
!-----------------------------------------------------------------------
          implicit none
          integer,parameter::NA=2,NB=6,NX=2,NFC=1,NAC=5,MULT=1
          integer::ian(NA)
          real(8)::r(3,NA)=0d0,cm(NB,NB),vlg(NAC,NAC),v0
          v0=-7.8823028937d0
          ian(:)=(/3,1/)
          r(1,1)=2.8549067485d0
          cm(:,:)=RESHAPE((/
     &        0.99113208, 0.03208639, 0.00708203,
     &        0.        , 0.        , 0.00668998,
     &       -0.17360814, 0.44709039,-0.34915269,
     &        0.        , 0.        , 0.54448418,
     &       -0.20882118, 0.80118856, 0.61277925,
     &        0.        , 0.        ,-0.13435286,
     &        0.        , 0.        , 0.        ,
     &        0.99757233,-0.06963791, 0.        ,
     &        0.        , 0.        , 0.        ,
     &        0.06963791, 0.99757233, 0.        ,
     &        0.08060495,-0.73913477, 1.00702597,
     &        0.        , 0.        , 1.23175157/),(/NB,NB/))
          vlg(:,:)=RESHAPE((/
     &       -0.6159993630d0,-0.0038471950d0,-0.0000000000d0,
     &        0.0000000000d0,-0.0369009102d0,
     &       -0.0038471950d0,-0.0058327444d0,-0.0000000000d0,
     &       -0.0000000000d0, 0.0108575341d0,
     &       -0.0000000000d0,-0.0000000000d0,-0.0011851114d0,
     &       -0.0000000000d0, 0.0000000000d0,
     &        0.0000000000d0,-0.0000000000d0,-0.0000000000d0,
     &       -0.0011851114d0, 0.0000000000d0,
     &       -0.0369009102d0, 0.0108575341d0, 0.0000000000d0,
     &        0.0000000000d0,-0.0234732387d0/),(/NAC,NAC/))
          call run_('LiH',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        subroutine test_ci_h2o_()
!-----------------------------------------------------------------------
!      $CONTRL SCFTYP=NONE RUNTYP=ENERGY CITYP=GUGA $END
!      $SYSTEM MWORDS=1 $END
!      $BASIS GBASIS=STO NGAUSS=3 $END
!      $CIINP NRNFG(6)=1,1 NPFLG(7)=1 $END
!      $CIDRT NFZC=4 NDOC=1 NVAL=2 GROUP=C1 IEXCIT=2 $END
!      $GUESS GUESS=MOREAD NORB=7 $END
!      $DATA
!      HCP
!     C1
!      H           1.0   0.7581836745  -0.0380971262  -0.0000000000
!      H           1.0  -0.7581836745  -0.0380971263  -0.0000000000
!      O           8.0  -0.0000000000  -0.6738057475   0.0000000000
!      $END
!      $VEC
!      1  1-5.58384802E-03-5.58384801E-03 9.94216405E-01 2.58470187E-02-0.00000000E+00
!      1  2 4.16371973E-03-0.00000000E+00
!      2  1 1.55594810E-01 1.55594810E-01-2.33767763E-01 8.44460176E-01-3.37018785E-11
!      2  2 1.22817131E-01-0.00000000E+00
!      3  1 4.49215416E-01-4.49215416E-01-1.25878053E-11 6.42524106E-11 6.12668729E-01
!      3  2 0.00000000E+00 0.00000000E+00
!      4  1 2.95092943E-01 2.95092943E-01 1.04025209E-01-5.38115613E-01-0.00000000E+00
!      4  2 7.55923177E-01-0.00000000E+00
!      5  1 0.00000000E+00 0.00000000E+00 0.00000000E+00 0.00000000E+00 0.00000000E+00
!      5  2 0.00000000E+00 1.00000000E+00
!      6  1-7.69173135E-01-7.69173134E-01-1.25824647E-01 8.20152389E-01 2.62507181E-10
!      6  2 7.63469877E-01 0.00000000E+00
!      7  1-8.14614012E-01 8.14614012E-01 4.42137503E-11-3.12428086E-10 9.59840455E-01
!      7  2-2.12560210E-10 0.00000000E+00
!      $END
!-------------------------------------------------------------------------
          implicit none
          integer,parameter::NA=3,NB=7,NX=2,NFC=4,NAC=3,MULT=1
          integer::ian(NA)
          real(8)::r(3,NA)=0d0,cm(NB,NB),v0,vlg(NAC,NAC)
          v0=-74.9674791954d0
          ian(:)=(/1,1,8/)
          r(:,:)=RESHAPE((/
     &       1.4327593932d0,-0.0719931294d0,-0.0000000000d0,
     &      -1.4327593932d0,-0.0719931296d0,-0.0000000000d0,
     &      -0.0000000000d0,-1.2733082317d0, 0.0000000000d0/),(/3,NA/))
          cm(:,:)=RESHAPE((/
     &        -0.005584d0,-0.005584d0, 0.994216d0, 0.025847d0,
     &         0.000000d0, 0.004164d0, 0.000000d0,
     &         0.155595d0, 0.155595d0,-0.233768d0, 0.844460d0,
     &        -0.000000d0, 0.122817d0,-0.000000d0,
     &         0.449215d0,-0.449215d0,-0.000000d0, 0.000000d0,
     &         0.612669d0, 0.000000d0, 0.000000d0,
     &         0.295093d0, 0.295093d0, 0.104025d0,-0.538116d0,
     &        -0.000000d0, 0.755923d0,-0.000000d0,
     &         0.000000d0, 0.000000d0, 0.000000d0, 0.000000d0,
     &         0.000000d0, 0.000000d0, 1.000000d0,
     &        -0.769173d0,-0.769173d0,-0.125825d0, 0.820152d0,
     &         0.000000d0, 0.763470d0, 0.000000d0,
     &        -0.814614d0, 0.814614d0, 0.000000d0,-0.000000d0,
     &         0.959840d0,-0.000000d0, 0.000000d0
     &         /),(/NB,NB/))
          vlg(:,:)=RESHAPE((/
     &        -0.7873783819d0,-0.0000000000d0,-0.0000000000d0,
     &        -0.0000000000d0,-0.0021582792d0,-0.0000000000d0,
     &        -0.0000000000d0,-0.0000000000d0,-0.0006363489d0
     &         /),(/NAC,NAC/))
          call run_('H2O',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        subroutine test_ci_c2h4_()
!-----------------------------------------------------------------------
!      $CONTRL SCFTYP=NONE RUNTYP=ENERGY CITYP=GUGA $END
!      $SYSTEM MWORDS=10 $END
!      $BASIS GBASIS=STO NGAUSS=3 $END
!      $CIINP NRNFG(6)=1,1 NPFLG(7)=1 $END
!      $CIDRT NDOC=2 NFZC=6 NVAL=2 GROUP=C1 IEXCIT=2 $END
!      $GUESS GUESS=MOREAD NORB=14 $END
!      $DATA
!     TITLE
!     C1
!     C     6.0     0.00000     0.20785     0.00000
!     C     6.0     0.00000     0.20785    -1.32600
!     H     1.0     0.00000     1.13185     0.59360
!     H     1.0     0.00000    -0.71615     0.59360
!     H     1.0     0.00000    -0.71615    -1.91960
!     H     1.0     0.00000     1.13185    -1.91960
!      $END
!      $VEC
!      1  1 7.01852684E-01 1.97934758E-02 0.00000000E+00 0.00000000E+00 2.12138296E-03
!      1  2 7.01852684E-01 1.97934758E-02 0.00000000E+00 0.00000000E+00-2.12138296E-03
!      1  3-4.64690283E-03-4.64690283E-03-4.64690283E-03-4.64690283E-03
!      2  1-7.01464173E-01-3.08779675E-02-0.00000000E+00-0.00000000E+00 4.34867312E-03
!      2  2 7.01464173E-01 3.08779675E-02-0.00000000E+00-0.00000000E+00 4.34867312E-03
!      2  3 4.79464830E-03 4.79464830E-03-4.79464830E-03-4.79464830E-03
!      3  1-1.78538631E-01 4.72907278E-01 0.00000000E+00 0.00000000E+00-1.16496793E-01
!      3  2-1.78538631E-01 4.72907278E-01 0.00000000E+00 0.00000000E+00 1.16496793E-01
!      3  3 1.12397190E-01 1.12397190E-01 1.12397190E-01 1.12397190E-01
!      4  1 1.35496586E-01-4.13738088E-01 0.00000000E+00 0.00000000E+00-2.01497955E-01
!      4  2-1.35496586E-01 4.13738088E-01 0.00000000E+00 0.00000000E+00-2.01497955E-01
!      4  3-2.23093112E-01-2.23093112E-01 2.23093112E-01 2.23093112E-01
!      5  1-0.00000000E+00-0.00000000E+00-0.00000000E+00 3.96608632E-01-0.00000000E+00
!      5  2-0.00000000E+00-0.00000000E+00-0.00000000E+00 3.96608632E-01-0.00000000E+00
!      5  3 2.60404111E-01-2.60404111E-01-2.60404111E-01 2.60404111E-01
!      6  1-1.48632222E-02 1.99473950E-02-0.00000000E+00-0.00000000E+00-4.97247616E-01
!      6  2-1.48632222E-02 1.99473950E-02-0.00000000E+00-0.00000000E+00 4.97247616E-01
!      6  3-2.18101374E-01-2.18101374E-01-2.18101374E-01-2.18101374E-01
!      7  1-0.00000000E+00-0.00000000E+00-0.00000000E+00-3.90985018E-01-0.00000000E+00
!      7  2-0.00000000E+00-0.00000000E+00-0.00000000E+00 3.90985018E-01-0.00000000E+00
!      7  3-3.51267390E-01 3.51267390E-01-3.51267390E-01 3.51267390E-01
!      8  1 0.00000000E+00 0.00000000E+00 6.34173881E-01 0.00000000E+00 0.00000000E+00
!      8  2 0.00000000E+00 0.00000000E+00 6.34173881E-01 0.00000000E+00 0.00000000E+00
!      8  3 0.00000000E+00 0.00000000E+00 0.00000000E+00 0.00000000E+00
!      9  1-0.00000000E+00-0.00000000E+00-8.12839020E-01-0.00000000E+00-0.00000000E+00
!      9  2-0.00000000E+00-0.00000000E+00 8.12839020E-01-0.00000000E+00-0.00000000E+00
!      9  3-0.00000000E+00-0.00000000E+00-0.00000000E+00-0.00000000E+00
!     10  1-0.00000000E+00-0.00000000E+00-0.00000000E+00 6.90058681E-01-0.00000000E+00
!     10  2-0.00000000E+00-0.00000000E+00-0.00000000E+00 6.90058681E-01-0.00000000E+00
!     10  3-6.15372757E-01 6.15372757E-01 6.15372757E-01-6.15372757E-01
!     11  1 1.70846634E-01-1.05916377E+00-0.00000000E+00-0.00000000E+00-1.90110958E-01
!     11  2-1.70846634E-01 1.05916377E+00-0.00000000E+00-0.00000000E+00-1.90110958E-01
!     11  3 6.31459953E-01 6.31459953E-01-6.31459953E-01-6.31459953E-01
!     12  1-1.22860933E-01 8.08608226E-01-0.00000000E+00-0.00000000E+00 5.20406094E-01
!     12  2-1.22860933E-01 8.08608226E-01-0.00000000E+00-0.00000000E+00-5.20406094E-01
!     12  3-6.22652917E-01-6.22652917E-01-6.22652917E-01-6.22652917E-01
!     13  1-0.00000000E+00-0.00000000E+00-0.00000000E+00 9.39995859E-01-0.00000000E+00
!     13  2-0.00000000E+00-0.00000000E+00-0.00000000E+00-9.39995859E-01-0.00000000E+00
!     13  3-5.98856294E-01 5.98856294E-01-5.98856294E-01 5.98856294E-01
!     14  1 1.09346139E-01-8.54018573E-01 0.00000000E+00 0.00000000E+00 1.16592373E+00
!     14  2-1.09346139E-01 8.54018573E-01 0.00000000E+00 0.00000000E+00 1.16592373E+00
!     14  3-1.40217474E-01-1.40217474E-01 1.40217474E-01 1.40217474E-01
!      $END
!-----------------------------------------------------------------------
          implicit none
          integer,parameter::NA=6,NB=14,NX=2,NFC=6,NAC=4,MULT=1
          integer::ian(NA)
          real(8)::r(3,NA)=0d0,cm(NB,NB),v0,vlg(NAC,NAC)
          v0=-77.1178813728d0
          ian(:)=(/6,6,1,1,1,1/)
          r(:,:)=RESHAPE((/
     &      0.0000000000d0, 0.3927795465d0, 0.0000000000d0,
     &      0.0000000000d0, 0.3927795465d0,-2.5057766597d0,
     &      0.0000000000d0, 2.1388863592d0, 1.1217413463d0,
     &      0.0000000000d0,-1.3533272661d0, 1.1217413463d0,
     &      0.0000000000d0,-1.3533272661d0,-3.6275180060d0,
     &      0.0000000000d0, 2.1388863592d0,-3.6275180060d0/),(/3,NA/))
          cm(:,:)=RESHAPE((/
     &      -0.70185268,-0.01979348, 0.         ,0.        ,-0.00212138,
     &      -0.70185268,-0.01979348, 0.         ,0.        , 0.00212138,
     &       0.0046469 , 0.0046469 ,.0046469    ,0.00464690,
     &       0.70146417, 0.03087797, 0.         ,0.        ,-0.00434867,
     &      -0.70146417,-0.03087797, 0.         ,0.        ,-0.00434867,
     &      -0.00479465,-0.00479465, 0.00479465 ,0.00479465,
     &       0.17853863,-0.4729073 , 0.        , 0.        , 0.11649677,
     &       0.17853863,-0.4729073 , 0.        , 0.        ,-0.11649677,
     &      -0.11239718,-0.11239718,-0.11239718,-0.11239718,
     &      -0.13549658, 0.41373807, 0.        , 0.        , 0.20149796,
     &       0.13549658,-0.41373807, 0.        , 0.        , 0.20149796,
     &       0.22309312, 0.22309312,-0.22309312,-0.22309312,
     &       0.        , 0.        , 0.        , 0.39660866, 0.        ,
     &       0.        , 0.        , 0.        , 0.39660866, 0.        ,
     &       0.26040409,-0.26040409,-0.26040409, 0.26040409,
     &      -0.01486323, 0.01994746, 0.        , 0.        ,-0.49724759,
     &      -0.01486323, 0.01994746, 0.        , 0.        , 0.49724759,
     &      -0.21810141,-0.21810141,-0.21810141,-0.21810141,
     &       0.        , 0.        , 0.        , 0.39098503, 0.       ,
     &       0.        , 0.        , 0.        ,-0.39098503, 0.       ,
     &       0.35126738,-0.35126738, 0.35126738,-0.35126738,
     &       0.        , 0.        ,-0.63417388, 0.        , 0.       ,
     &       0.        , 0.        ,-0.63417388, 0.        , 0.       ,
     &       0.        , 0.        , 0.        , 0.        ,
     &       0.        , 0.        ,-0.81283902, 0.        , 0.       ,
     &       0.        , 0.        , 0.81283902, 0.        , 0.       ,
     &       0.        , 0.        , 0.        , 0.        ,
     &       0.        , 0.        , 0.        ,-0.69005867, 0.       ,
     &       0.        , 0.        , 0.        ,-0.69005867, 0.       ,
     &       0.61537277,-0.61537277,-0.61537277, 0.61537277,
     &      -0.17084664, 1.05916378, 0.        , 0.        , 0.19011094,
     &       0.17084664,-1.05916378, 0.        , 0.        , 0.19011094,
     &      -0.63145995,-0.63145995, 0.63145995, 0.63145995,
     &      -0.12286093, 0.80860821, 0.        , 0.        , 0.52040613,
     &      -0.12286093, 0.80860821, 0.        , 0.        ,-0.52040613,
     &      -0.62265291,-0.62265291,-0.62265291,-0.62265291,
     &       0.       ,  0.       ,  0.       ,  0.93999585, 0.        ,
     &       0.       ,  0.       ,  0.       , -0.93999585, 0.        ,
     &      -0.5988563,  0.5988563, -0.5988563,  0.59885630,
     &       0.10934614,-0.85401856, 0.        , 0.        , 1.16592373,
     &      -0.10934614, 0.85401856, 0.        , 0.        , 1.16592373,
     &      -0.14021749,-0.14021749, 0.14021749, 0.14021749
     &      /),(/NB,NB/))
          vlg(:,:)=RESHAPE((/
     &      -0.9068340701d0, 0.0000000000d0,-0.0000000000d0,
     &       0.0000000000d0,
     &       0.0000000000d0,-0.6969235079d0, 0.0000000000d0,
     &      -0.0000000000d0,
     &      -0.0000000000d0, 0.0000000000d0,-0.0815158796d0,
     &      -0.0000000000d0,
     &       0.0000000000d0,-0.0000000000d0,-0.0000000000d0,
     &      -0.0034117761d0/),(/NAC,NAC/))
          call run_('C2H4',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        subroutine test_ci_c2h4fzv_()
!-----------------------------------------------------------------------
!      $CONTRL SCFTYP=NONE RUNTYP=ENERGY CITYP=GUGA $END
!      $SYSTEM MWORDS=10 $END
!      $BASIS GBASIS=STO NGAUSS=3 $END
!      $CIINP NRNFG(6)=1,1 NPFLG(7)=1 $END
!      $CIDRT NDOC=2 NFZC=6 NVAL=1 NEXT=1 GROUP=C1 IEXCIT=2 $END
!      $GUESS GUESS=MOREAD NORB=14 $END
!      $DATA
!     TITLE
!     C1
!     C     6.0     0.00000     0.20785     0.00000
!     C     6.0     0.00000     0.20785    -1.32600
!     H     1.0     0.00000     1.13185     0.59360
!     H     1.0     0.00000    -0.71615     0.59360
!     H     1.0     0.00000    -0.71615    -1.91960
!     H     1.0     0.00000     1.13185    -1.91960
!      $END
!      $VEC
!      1  1 7.01852684E-01 1.97934758E-02 0.00000000E+00 0.00000000E+00 2.12138296E-03
!      1  2 7.01852684E-01 1.97934758E-02 0.00000000E+00 0.00000000E+00-2.12138296E-03
!      1  3-4.64690283E-03-4.64690283E-03-4.64690283E-03-4.64690283E-03
!      2  1-7.01464173E-01-3.08779675E-02-0.00000000E+00-0.00000000E+00 4.34867312E-03
!      2  2 7.01464173E-01 3.08779675E-02-0.00000000E+00-0.00000000E+00 4.34867312E-03
!      2  3 4.79464830E-03 4.79464830E-03-4.79464830E-03-4.79464830E-03
!      3  1-1.78538631E-01 4.72907278E-01 0.00000000E+00 0.00000000E+00-1.16496793E-01
!      3  2-1.78538631E-01 4.72907278E-01 0.00000000E+00 0.00000000E+00 1.16496793E-01
!      3  3 1.12397190E-01 1.12397190E-01 1.12397190E-01 1.12397190E-01
!      4  1 1.35496586E-01-4.13738088E-01 0.00000000E+00 0.00000000E+00-2.01497955E-01
!      4  2-1.35496586E-01 4.13738088E-01 0.00000000E+00 0.00000000E+00-2.01497955E-01
!      4  3-2.23093112E-01-2.23093112E-01 2.23093112E-01 2.23093112E-01
!      5  1-0.00000000E+00-0.00000000E+00-0.00000000E+00 3.96608632E-01-0.00000000E+00
!      5  2-0.00000000E+00-0.00000000E+00-0.00000000E+00 3.96608632E-01-0.00000000E+00
!      5  3 2.60404111E-01-2.60404111E-01-2.60404111E-01 2.60404111E-01
!      6  1-1.48632222E-02 1.99473950E-02-0.00000000E+00-0.00000000E+00-4.97247616E-01
!      6  2-1.48632222E-02 1.99473950E-02-0.00000000E+00-0.00000000E+00 4.97247616E-01
!      6  3-2.18101374E-01-2.18101374E-01-2.18101374E-01-2.18101374E-01
!      7  1-0.00000000E+00-0.00000000E+00-0.00000000E+00-3.90985018E-01-0.00000000E+00
!      7  2-0.00000000E+00-0.00000000E+00-0.00000000E+00 3.90985018E-01-0.00000000E+00
!      7  3-3.51267390E-01 3.51267390E-01-3.51267390E-01 3.51267390E-01
!      8  1 0.00000000E+00 0.00000000E+00 6.34173881E-01 0.00000000E+00 0.00000000E+00
!      8  2 0.00000000E+00 0.00000000E+00 6.34173881E-01 0.00000000E+00 0.00000000E+00
!      8  3 0.00000000E+00 0.00000000E+00 0.00000000E+00 0.00000000E+00
!      9  1-0.00000000E+00-0.00000000E+00-8.12839020E-01-0.00000000E+00-0.00000000E+00
!      9  2-0.00000000E+00-0.00000000E+00 8.12839020E-01-0.00000000E+00-0.00000000E+00
!      9  3-0.00000000E+00-0.00000000E+00-0.00000000E+00-0.00000000E+00
!     10  1-0.00000000E+00-0.00000000E+00-0.00000000E+00 6.90058681E-01-0.00000000E+00
!     10  2-0.00000000E+00-0.00000000E+00-0.00000000E+00 6.90058681E-01-0.00000000E+00
!     10  3-6.15372757E-01 6.15372757E-01 6.15372757E-01-6.15372757E-01
!     11  1 1.70846634E-01-1.05916377E+00-0.00000000E+00-0.00000000E+00-1.90110958E-01
!     11  2-1.70846634E-01 1.05916377E+00-0.00000000E+00-0.00000000E+00-1.90110958E-01
!     11  3 6.31459953E-01 6.31459953E-01-6.31459953E-01-6.31459953E-01
!     12  1-1.22860933E-01 8.08608226E-01-0.00000000E+00-0.00000000E+00 5.20406094E-01
!     12  2-1.22860933E-01 8.08608226E-01-0.00000000E+00-0.00000000E+00-5.20406094E-01
!     12  3-6.22652917E-01-6.22652917E-01-6.22652917E-01-6.22652917E-01
!     13  1-0.00000000E+00-0.00000000E+00-0.00000000E+00 9.39995859E-01-0.00000000E+00
!     13  2-0.00000000E+00-0.00000000E+00-0.00000000E+00-9.39995859E-01-0.00000000E+00
!     13  3-5.98856294E-01 5.98856294E-01-5.98856294E-01 5.98856294E-01
!     14  1 1.09346139E-01-8.54018573E-01 0.00000000E+00 0.00000000E+00 1.16592373E+00
!     14  2-1.09346139E-01 8.54018573E-01 0.00000000E+00 0.00000000E+00 1.16592373E+00
!     14  3-1.40217474E-01-1.40217474E-01 1.40217474E-01 1.40217474E-01
!      $END
!-----------------------------------------------------------------------
          implicit none
          integer,parameter::NA=6,NB=14,NX=2,NFC=6,NAC=3,MULT=1
          integer::ian(NA)
          real(8)::r(3,NA)=0d0,cm(NB,NB),v0,vlg(NAC,NAC)
          v0=-77.115542997d0
          ian(:)=(/6,6,1,1,1,1/)
          r(:,:)=RESHAPE((/
     &      0.0000000000d0, 0.3927795465d0, 0.0000000000d0,
     &      0.0000000000d0, 0.3927795465d0,-2.5057766597d0,
     &      0.0000000000d0, 2.1388863592d0, 1.1217413463d0,
     &      0.0000000000d0,-1.3533272661d0, 1.1217413463d0,
     &      0.0000000000d0,-1.3533272661d0,-3.6275180060d0,
     &      0.0000000000d0, 2.1388863592d0,-3.6275180060d0/),(/3,NA/))
          cm(:,:)=RESHAPE((/
     &      -0.70185268,-0.01979348, 0.         ,0.        ,-0.00212138,
     &      -0.70185268,-0.01979348, 0.         ,0.        , 0.00212138,
     &       0.0046469 , 0.0046469 ,.0046469    ,0.00464690,
     &       0.70146417, 0.03087797, 0.         ,0.        ,-0.00434867,
     &      -0.70146417,-0.03087797, 0.         ,0.        ,-0.00434867,
     &      -0.00479465,-0.00479465, 0.00479465 ,0.00479465,
     &       0.17853863,-0.4729073 , 0.        , 0.        , 0.11649677,
     &       0.17853863,-0.4729073 , 0.        , 0.        ,-0.11649677,
     &      -0.11239718,-0.11239718,-0.11239718,-0.11239718,
     &      -0.13549658, 0.41373807, 0.        , 0.        , 0.20149796,
     &       0.13549658,-0.41373807, 0.        , 0.        , 0.20149796,
     &       0.22309312, 0.22309312,-0.22309312,-0.22309312,
     &       0.        , 0.        , 0.        , 0.39660866, 0.        ,
     &       0.        , 0.        , 0.        , 0.39660866, 0.        ,
     &       0.26040409,-0.26040409,-0.26040409, 0.26040409,
     &      -0.01486323, 0.01994746, 0.        , 0.        ,-0.49724759,
     &      -0.01486323, 0.01994746, 0.        , 0.        , 0.49724759,
     &      -0.21810141,-0.21810141,-0.21810141,-0.21810141,
     &       0.        , 0.        , 0.        , 0.39098503, 0.       ,
     &       0.        , 0.        , 0.        ,-0.39098503, 0.       ,
     &       0.35126738,-0.35126738, 0.35126738,-0.35126738,
     &       0.        , 0.        ,-0.63417388, 0.        , 0.       ,
     &       0.        , 0.        ,-0.63417388, 0.        , 0.       ,
     &       0.        , 0.        , 0.        , 0.        ,
     &       0.        , 0.        ,-0.81283902, 0.        , 0.       ,
     &       0.        , 0.        , 0.81283902, 0.        , 0.       ,
     &       0.        , 0.        , 0.        , 0.        ,
     &       0.        , 0.        , 0.        ,-0.69005867, 0.       ,
     &       0.        , 0.        , 0.        ,-0.69005867, 0.       ,
     &       0.61537277,-0.61537277,-0.61537277, 0.61537277,
     &      -0.17084664, 1.05916378, 0.        , 0.        , 0.19011094,
     &       0.17084664,-1.05916378, 0.        , 0.        , 0.19011094,
     &      -0.63145995,-0.63145995, 0.63145995, 0.63145995,
     &      -0.12286093, 0.80860821, 0.        , 0.        , 0.52040613,
     &      -0.12286093, 0.80860821, 0.        , 0.        ,-0.52040613,
     &      -0.62265291,-0.62265291,-0.62265291,-0.62265291,
     &       0.       ,  0.       ,  0.       ,  0.93999585, 0.        ,
     &       0.       ,  0.       ,  0.       , -0.93999585, 0.        ,
     &      -0.5988563,  0.5988563, -0.5988563,  0.59885630,
     &       0.10934614,-0.85401856, 0.        , 0.        , 1.16592373,
     &      -0.10934614, 0.85401856, 0.        , 0.        , 1.16592373,
     &      -0.14021749,-0.14021749, 0.14021749, 0.14021749
     &      /),(/NB,NB/))
          vlg(:,:)=RESHAPE((/
     &      -0.9039502339d0,-0.0000000000d0, 0.0000000000d0,
     &      -0.0000000000d0,-0.6966900059d0, 0.0000000000d0,
     &       0.0000000000d0, 0.0000000000d0,-0.0814677672d0
     &      /),(/NAC,NAC/))
          call run_('C2H4fzv',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        subroutine test_ci_ch3_()
!-----------------------------------------------------------------------
!       $CONTRL SCFTYP=ROHF MULT=2 RUNTYP=ENERGY CITYP=GUGA $END
!       $SYSTEM MWORDS=10 $END
!       $BASIS GBASIS=STO NGAUSS=3 $END
!       $SCF DIRSCF=.T. $END
!       $CIDRT NFZC=3 NDOC=1 NALP=1 NVAL=1 GROUP=C1 IEXCIT=2 $END
!       $DATA
!      Title
!       c1
!       C           6.0  -0.0000000013  -0.0000000000  -0.0000000000
!       H           1.0   0.5390728116  -0.9337014944   0.0000000000
!       H           1.0   0.5390728116   0.9337014944   0.0000000000
!       H           1.0  -1.0781456218   0.0000000000   0.0000000000
!       $END
!-----------------------------------------------------------------------
          implicit none
          integer,parameter::NA=4,NB=8,NX=2,NFC=3,NAC=3,MULT=2
          integer::ian(NA)
          real(8)::r(3,NA)=0d0,cm(NB,NB),v0,vlg(NAC,NAC)
          v0=-39.0743509729d0
          ian(:)=(/6,1,1,1/)
          r(:,:)=RESHAPE((/
     &     -0.0000000025d0,-0.0000000000d0,-0.0000000000d0,
     &      1.0186999014d0,-1.7644399787d0, 0.0000000000d0,
     &      1.0186999014d0, 1.7644399787d0, 0.0000000000d0,
     &     -2.0373998001d0, 0.0000000000d0, 0.0000000000d0/),(/3,NA/))
          cm(:,:)=RESHAPE((/
     &      0.992952,  0.033017,  0.      ,  0.      ,
     &     -0.      , -0.007375, -0.007375, -0.007375,
     &     -0.220623,  0.645272,  0.      ,  0.      ,
     &      0.      ,  0.22348 ,  0.22348 ,  0.22348 ,
     &     -0.      ,  0.      ,  0.549158,  0.      ,
     &      0.      ,  0.247694,  0.247694, -0.495388,
     &      0.      ,  0.      ,  0.      ,  0.549158,
     &      0.      , -0.429018,  0.429018, -0.      ,
     &      0.      ,  0.      ,  0.      ,  0.      ,
     &      1.      ,  0.      ,  0.      ,  0.      ,
     &     -0.231191,  1.452371, -0.      ,  0.      ,
     &      0.      , -0.752345, -0.752345, -0.752345,
     &      0.      ,  0.      ,  0.      ,  1.15768 ,
     &      0.      ,  0.88262 , -0.88262 ,  0.      ,
     &     -0.      ,  0.      ,  1.15768 , -0.      ,
     &      0.      , -0.509581, -0.509581,  1.019162
     &      /),(/NB,NB/))
          vlg(:,:)=RESHAPE((/
     &     -1.0624749751d0, 0.0000000000d0, 0.0000000010d0,
     &      0.0000000000d0,-0.3475403260d0, 0.0000000000d0,
     &     -0.0000000132d0, 0.0000000000d0,-0.0037255002d0
     &      /),(/NAC,NAC/))
          call run_('CH3',ian,r,cm,NX,NFC,NAC,MULT,v0,vlg)
        end subroutine

        integer function ip_(i,j) result(ij)
          ! Canonical index packing for a symmetric matrix.
          implicit none
          integer,intent(in)::i,j
          integer::ii,jj
          ii=max(i,j)
          jj=min(i,j)
          ij=(ii-1)*ii/2+jj
        end function

        subroutine iup_(ij,i,j)
          ! Unpack the canonical index for a symmetric matrix (1e).
          implicit none
          integer,intent(in)::ij
          integer,intent(out)::i,j
          real(8)::vt
          vt=0.5d0*(-1d0+SQRT(1d0+8*ij))
          i=CEILING(vt)
          j=ij-(i-1)*i/2
        end subroutine

        subroutine asserttrue_(mes,ok)
          implicit none
          character(*),intent(in)::mes
          logical,intent(in)::ok
          if (ok) then
            write(*,'(a,"...ok")') TRIM(mes)
          else
            write(*,'(a,"...failure")') TRIM(mes)
            stop 1
          end if
        end subroutine

        subroutine test_main()
          implicit none
          write(*,'("--- CI ---")')
          call test_ci_H2_()
          call test_ci_H3_()
          call test_ci_lih_()
          call test_ci_h2o_()
          call test_ci_c2h4_()
          call test_ci_c2h4fzv_()
          call test_ci_ch3_()
        end subroutine

      end module

      program main
        use test_ci,only: test_main
        implicit none
        call test_main()
      end program
